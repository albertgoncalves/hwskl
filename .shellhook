#!/usr/bin/env bash

for x in bin build out; do
    if [ ! -d "$PWD/$x" ]; then
        mkdir "$PWD/$x"
    fi
done

export FLAGS=(
    "-fdiagnostics-color=always"
    -fprof-auto
    -fprof-cafs
    -funbox-strict-fields
    "-optl-fuse-ld=lld"
    "-outputdir $PWD/build"
    -prof
    -Wall
    -Wcompat
    -Werror
    -Widentities
    -Wincomplete-record-updates
    -Wincomplete-uni-patterns
    -Wmissing-export-lists
    -Wmonomorphism-restriction
    -Wno-name-shadowing
    -Wno-unused-top-binds
    -Wno-x-partial
    -Wpartial-fields
    -Wunused-packages
    -Wunused-type-patterns
)

lint () {
    hlint "$1"
    ormolu -i --no-cabal "$1"
}

runh () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    path=$PWD
    (
        if [ "$(ls -A "$path/build")" ]; then
            rm "$path/build"/*
        fi
        cd "$path/src" || return
        ghc "${FLAGS[@]}" -o "$path/bin/$handle" "$handle.hs" || return
        cd "$path" || return
        "$path/bin/$handle" +RTS -xc -RTS
    )
}

export -f lint
export -f runh
