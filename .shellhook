#!/usr/bin/env bash

if [ "$(uname -s)" = "Darwin" ]; then
    alias ls="ls --color=auto"
    alias ll="ls -al"
else
    alias open="xdg-open"
fi

export WD=$PWD

for x in bin build; do
    if [ ! -d "$WD/$x" ]; then
        mkdir "$WD/$x"
    fi
done

hsall () {
    find "$WD/src" -type f -name '*.hs' | parallel '
        echo {}
        hlint {}
        ormolu -m inplace {}
        echo ""
    '
}

export ARGS=(
    -fprof-auto
    -prof
    -rtsopts
    -Wall
    -Werror
    -Wno-unused-top-binds
)

runh () {
    handle=$(echo "$1" | sed 's/^[a-z\/]*\/\(.*\)\.[a-z]*$/\1/')
    pin=$PWD
    cp "$1" "$WD/build/$handle.hs"
    (
        cd "$WD/build" || return
        ghc "${ARGS[@]}" -o "$WD/bin/$handle" "$handle.hs" || return
        cd "$pin" || return
        if [ -z "$2" ]; then
            "$WD/bin/$handle"
        else
            "$WD/bin/$handle" +RTS -pa -RTS
        fi
    )
}

export -f runh
export -f hsall
alias ormolu="ormolu -m inplace"
